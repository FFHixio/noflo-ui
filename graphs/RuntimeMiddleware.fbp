# @runtime noflo-browser
# @icon cogs
INPORT=Dispatch.IN:IN
OUTPORT=Passed.OUT:PASS
OUTPORT=NewActions.OUT:NEW

'runtime:open,storage:opened,context:edges,project:fromruntime,storage:ready,storage:stored:runtime,runtime:start,runtime:stop,runtime:reconnect,runtime:sendComponent,runtime:sendGraphChanges,runtime:sendGraph,runtime:sendSubgraph,runtime:loadTests,runtime:runTests' -> ROUTES Dispatch(ui/DispatchAction)
Dispatch PASS -> IN Passed(core/Merge)

# New actions generated by this middleware
'storage:save:project' -> ACTION ProjectSaveAction(ui/SetAction) OUT -> IN NewActions(core/Merge)
'storage:save:graph' -> ACTION GraphSaveAction(ui/SetAction) OUT -> IN NewActions
'storage:save:component' -> ACTION ComponentSaveAction(ui/SetAction) OUT -> IN NewActions
'storage:save:spec' -> ACTION SpecSaveAction(ui/SetAction) OUT -> IN NewActions
'flowhub:runtimes:register' -> ACTION RuntimeRegisterAction(ui/SetAction) OUT -> IN NewActions
'storage:save:runtime' -> ACTION RuntimeSaveAction(ui/SetAction) OUT -> IN NewActions
'runtime:error' -> ACTION RuntimeErrorAction(ui/SetAction) OUT -> IN NewActions
'runtime:opened' -> ACTION RuntimeOpenedAction(ui/SetAction) OUT -> IN NewActions
'runtime:opening' -> ACTION RuntimeOpeningAction(ui/SetAction) OUT -> IN NewActions
'runtime:status' -> ACTION RuntimeStatusAction(ui/SetAction) OUT -> IN NewActions
'runtime:components' -> ACTION RuntimeComponentsAction(ui/SetAction) OUT -> IN NewActions
'runtime:component' -> ACTION RuntimeComponentAction(ui/SetAction) OUT -> IN NewActions
'runtime:started' -> ACTION RuntimeStartedAction(ui/SetAction) OUT -> IN NewActions
'runtime:stopped' -> ACTION RuntimeStoppedAction(ui/SetAction) OUT -> IN NewActions
'runtime:packet' -> ACTION RuntimePacketAction(ui/SetAction) OUT -> IN NewActions
'runtime:icon' -> ACTION RuntimeIconAction(ui/SetAction) OUT -> IN NewActions
'runtime:output' -> ACTION RuntimeOutputAction(ui/SetAction) OUT -> IN NewActions
'runtime:networkerror' -> ACTION RuntimeNetworkErrorAction(ui/SetAction) OUT -> IN NewActions
'runtime:processerror' -> ACTION RuntimeProcessErrorAction(ui/SetAction) OUT -> IN NewActions
'runtime:protocolerror' -> ACTION RuntimeProtocolErrorAction(ui/SetAction) OUT -> IN NewActions
'runtime:loadTests' -> ACTION RuntimeLoadTestsAction(ui/SetAction) OUT -> IN NewActions
'runtime:testsuites' -> ACTION RuntimeTestSuitesAction(ui/SetAction) OUT -> IN NewActions
'application:recreatestate' -> ACTION ApplicationRecreateAction(ui/SetAction) OUT -> IN NewActions
'storage:opened' -> ACTION StorageOpenedAction(ui/SetAction) OUT -> IN Passed
'storage:ready' -> ACTION StorageReadyAction(ui/SetAction) OUT -> IN Passed
'context:edges' -> ACTION ContextEdgesAction(ui/SetAction) OUT -> IN Passed

# Open runtime in live mode
'runtimes,projects' -> KEYS GetRuntimesState(ui/GetActionValues)
Dispatch HANDLE[0] -> IN GetRuntimesState
GetRuntimesState VALUES[0] -> RUNTIMES PopulateRuntimeData(ui/PopulateRuntimeData)
GetRuntimesState OUT -> IN PopulateRuntimeData
PopulateRuntimeData OUT -> IN[0] GetClient
PopulateRuntimeData OUT -> IN RuntimeOpeningAction
PopulateRuntimeData NEW -> UPDATED GetClient
PopulateRuntimeData ERROR -> IN RuntimeErrorAction
GetClient OUT[0] -> IN OpenLiveMode(ui/OpenLiveMode)
GetRuntimesState VALUES[1] -> PROJECTS OpenLiveMode
GetClient CLIENT[0] -> CLIENT OpenLiveMode
OpenLiveMode OUT -> IN RuntimeOpenedAction
OpenLiveMode OUT -> IN RuntimeLoadTestsAction
# Create a project based on data on runtime side
OpenLiveMode PROJECT -> IN ProjectSaveAction
OpenLiveMode GRAPH -> IN GraphSaveAction
OpenLiveMode COMPONENT -> IN ComponentSaveAction
OpenLiveMode SPEC -> IN SpecSaveAction
OpenLiveMode RUNTIME -> IN RuntimeSaveAction
OpenLiveMode ERROR -> IN RuntimeErrorAction

# Connect runtime associated with project, if any
'runtimes' -> KEYS GetProjectRuntimesState(ui/GetActionValues)
Dispatch HANDLE[1] -> IN GetProjectRuntimesState
GetProjectRuntimesState VALUES[0] -> RUNTIMES PopulateProjectRuntime(ui/PopulateProjectRuntime)
GetProjectRuntimesState OUT -> IN PopulateProjectRuntime
PopulateProjectRuntime OUT -> IN[1] GetClient
PopulateProjectRuntime SKIPPED -> IN StorageOpenedAction
GetClient OUT[1] -> IN OpenProjectMode(ui/OpenProjectMode)
GetClient CLIENT[1] -> CLIENT OpenProjectMode
OpenProjectMode OUT -> IN StorageOpenedAction
OpenProjectMode ERROR -> IN RuntimeErrorAction

# Send selected edges to runtime
'graphs,project' -> KEYS GetEdgeState(ui/GetActionValues)
Dispatch HANDLE[2] -> IN HasEdgeRuntime(ui/HasActionRuntime)
HasEdgeRuntime OUT -> IN GetEdgeState
# If there is no runtime we don't send edges
HasEdgeRuntime MISSED -> IN Passed
GetEdgeState STATE -> IN[2] GetClient
GetClient CLIENT[2] -> CLIENT SendEdges(ui/SendEdges)
GetEdgeState VALUES[0] -> GRAPHS SendEdges
GetEdgeState VALUES[1] -> PROJECT SendEdges
GetEdgeState OUT -> EDGES SendEdges
SendEdges OUT -> IN ContextEdgesAction
SendEdges ERROR -> IN RuntimeErrorAction

# Handle legacy runtime to project action with a proper error
Dispatch HANDLE[3] -> IN GetRuntimeToProjectValues(ui/GetActionValues)
GetRuntimeToProjectValues OUT -> IN[3] GetClient
GetClient OUT[3] -> IN RuntimeToProject(ui/RuntimeToProject)
GetClient CLIENT[3] -> CLIENT RuntimeToProject(ui/RuntimeToProject)
RuntimeToProject ERROR -> IN RuntimeErrorAction

# Populate local runtimes
'runtimes' -> KEYS GetStoredRuntimes(ui/GetActionValues)
Dispatch HANDLE[4] -> IN GetStoredRuntimes
GetStoredRuntimes VALUES[0] -> IN EnsureLocalRuntimes(ui/EnsureLocalRuntimes)
EnsureLocalRuntimes OUT -> IN RuntimeSaveAction
EnsureLocalRuntimes RUNTIMES -> INITIAL GetClient(ui/GetRuntimeClient)
GetStoredRuntimes OUT -> IN StorageReadyAction
GetClient ERROR -> IN RuntimeErrorAction

# Listen for runtime changes
GetClient INSTANCE -> IN ListenRuntime(ui/ListenRuntime)
ListenRuntime RUNTIMEUPDATE -> IN RuntimeRegisterAction
ListenRuntime STATUS -> IN RuntimeStatusAction
ListenRuntime COMPONENTS -> IN RuntimeComponentsAction
ListenRuntime COMPONENT -> IN RuntimeComponentAction
ListenRuntime STARTED -> IN RuntimeStartedAction
ListenRuntime STOPPED -> IN RuntimeStoppedAction
ListenRuntime PACKET -> IN RuntimePacketAction
ListenRuntime ICON -> IN RuntimeIconAction
ListenRuntime OUTPUT -> IN RuntimeOutputAction
ListenRuntime NETWORKERROR -> IN RuntimeNetworkErrorAction
ListenRuntime PROCESSERROR -> IN RuntimeProcessErrorAction
ListenRuntime PROTOCOLERROR -> IN RuntimeProtocolErrorAction
ListenRuntime ERROR -> IN RuntimeErrorAction

# Update fbp-clients based on new runtime information
Dispatch HANDLE[5] -> UPDATED GetClient
GetClient UPDATED -> IN Passed

# Control network start
Dispatch HANDLE[6] -> IN GetStartValues(ui/GetActionValues)
GetStartValues OUT -> IN[4] GetClient
GetClient OUT[4] -> IN StartNetwork(ui/StartNetwork)
GetClient CLIENT[4] -> CLIENT StartNetwork
StartNetwork OUT -> IN RuntimeStartedAction
StartNetwork ERROR -> IN RuntimeErrorAction

# Control network stop
Dispatch HANDLE[7] -> IN GetStopValues(ui/GetActionValues)
GetStopValues OUT -> IN[5] GetClient
GetClient OUT[5] -> IN StopNetwork(ui/StopNetwork)
GetClient CLIENT[5] -> CLIENT StopNetwork
StopNetwork OUT -> IN RuntimeStoppedAction
StopNetwork ERROR -> IN RuntimeErrorAction

# Runtime reconnection
Dispatch HANDLE[8] -> IN GetReconnectValues(ui/GetActionValues)
GetReconnectValues OUT -> IN[6] GetClient
GetClient OUT[6] -> IN ReconnectRuntime(ui/ReconnectRuntime)
GetClient CLIENT[6] -> CLIENT ReconnectRuntime
ReconnectRuntime OUT -> IN ApplicationRecreateAction
ReconnectRuntime ERROR -> IN RuntimeErrorAction

# Sending component changes to runtime
'project' -> KEYS GetComponentValues(ui/GetActionValues)
Dispatch HANDLE[9] -> IN GetComponentValues
GetComponentValues OUT -> IN[7] GetClient
GetClient OUT[7] -> IN SendComponentChanges(ui/SendComponentChanges)
GetClient CLIENT[7] -> CLIENT SendComponentChanges
GetComponentValues VALUES[0] -> PROJECT SendComponentChanges
SendComponentChanges OUT -> IN RuntimeComponentAction
SendComponentChanges ERROR -> IN RuntimeErrorAction

# Sending graph changes to runtime
'project' -> KEYS GetGraphChangeValues(ui/GetActionValues)
Dispatch HANDLE[10] -> IN GetGraphChangeValues
GetGraphChangeValues OUT -> IN[8] GetClient
GetClient OUT[8] -> IN SendGraphChanges(ui/SendGraphChanges)
GetClient CLIENT[8] -> CLIENT SendGraphChanges
GetGraphChangeValues VALUES[0] -> PROJECT SendGraphChanges
SendGraphChanges ERROR -> IN RuntimeErrorAction

# Sending new graphs to runtime
'project' -> KEYS GetNewGraphValues(ui/GetActionValues)
Dispatch HANDLE[11] -> IN GetNewGraphValues
GetNewGraphValues OUT -> IN[9] GetClient
GetClient OUT[9] -> IN SendNewGraph(ui/SendNewGraph)
GetClient CLIENT[9] -> CLIENT SendNewGraph
SendNewGraph ERROR -> IN RuntimeErrorAction

# Sending new subgraphs to runtime
'project' -> KEYS GetSubgraphValues(ui/GetActionValues)
Dispatch HANDLE[12] -> IN GetSubgraphValues
GetSubgraphValues OUT -> IN[10] GetClient
GetClient OUT[10] -> IN SendSubgraph(ui/SendSubgraph)
GetClient CLIENT[10] -> CLIENT SendSubgraph
SendSubgraph OUT -> IN GraphSaveAction
SendSubgraph ERROR -> IN RuntimeErrorAction

# Loading project fbp-Specs
'project' -> KEYS GetLoadTestsValues(ui/GetActionValues)
Dispatch HANDLE[13] -> IN GetLoadTestsValues
GetLoadTestsValues OUT -> IN LoadTests(ui/LoadTests)
LoadTests OUT -> IN Async(core/RepeatAsync) OUT -> IN RuntimeTestSuitesAction
LoadTests ERROR -> IN RuntimeErrorAction

# Executing fbp-spec tests against the runtime
'project' -> KEYS GetRunTestsValues(ui/GetActionValues)
Dispatch HANDLE[14] -> IN GetRunTestsValues
GetRunTestsValues OUT -> IN[11] GetClient
GetClient OUT[11] -> IN RunTests(ui/RunTests)
GetClient CLIENT[11] -> CLIENT RunTests
RunTests OUT -> IN RuntimeTestSuitesAction
RunTests ERROR -> IN RuntimeErrorAction
